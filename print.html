<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1.0, user-scalable=no" />
    <title>Fire ðŸ”¥ Map!</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>

    <script src="https://unpkg.com/esri-leaflet@^3.0.8/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-vector@3.1.3/dist/esri-leaflet-vector.js"></script> 
    <script src="https://unpkg.com/esri-leaflet@^3.0.8/dist/esri-leaflet.js"></script>


    <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@^3.0.0/dist/esri-leaflet-geocoder.css"">
    <script src="https://unpkg.com/esri-leaflet-geocoder@^3.0.0/dist/esri-leaflet-geocoder.js"></script>
    
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/L.Geoserver.js"></script>
    <script src="https://kit.fontawesome.com/2aff34493a.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

    <script src="js/leaflet-simple-map-screenshoter.js"></script>
    <script src="https://unpkg.com/file-saver/dist/FileSaver.js"></script>

    <style>
        #map { height: 750px; width: 1100px; background: #aad3df; }
        html, body {
			height: 100%;
			margin: 0;
		}
        .target {font-size: xx-large;}

        
        .geocoder-control {
            height: 34px !important;
        }

        #legend {
            background: #5A6675;
            padding: 3px;
            width: 200px;
            visibility: hidden;
            position: absolute;
           /*  left: 200px;
            top: 200px; */
            margin-left: 7px;
            margin-right: 7px;
            z-index: 999;
        }
    </style>

    
</head>
<body>
    <div id="map"></div>
    <div id='legend'>
        
        <img src="img/legend.png" style="width:200px;" />
    </div> 
    <div id="mapBigScreeningState"></div>
    <script>

        const apiKey = 'AAPK0192829bddd94a6fa77a9f5268fd7534-s34w8rj1KstCMBJV6l9QIkdF9Qs3pa8CNcIZfT7MoHApvpxHwKptuXx9Ln3ZDn8';

        var map = L.map('map').setView([40.845067887978345, -122.08557128906251], 8);

    /*     // basemap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);
    */

   // basemap
   L.control.scale().addTo(map);

        // ESRI world physical map - shows morphology
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            transparent: true,
            opacity: 0.8
        }).addTo(map);
        
        // fire severity layer
        var fsLayer = L.tileLayer.wms('https://www.wfas.net/cgi-bin/mapserv?map=/var/www/html/nfdr/mapfiles/wfas_wms_new.map', {
            layers: 'fbxday0',
            format: 'image/png',
            transparent: true,
            opacity: 0.7,
            attribution: "WFAS"
        }).addTo(map);

        // ESRI Overlay of roads and towns and places
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
        }).addTo(map);

        // us counties filtered by California
        var countyLayer = L.Geoserver.wms("https://joydifranza.com:8443/geoserver/wfs", {
            layers: 'open_data:US_Counties',
            CQL_FILTER: "statefp='06'",
            attribution: "US Census Bureau"
        });
        countyLayer.addTo(map); 

        // us states
        var stateLayer = L.Geoserver.wms("https://joydifranza.com:8443/geoserver/wfs", {
            layers: 'open_data:US_States',
            attribution: "US Census Bureau"
        })
        stateLayer.addTo(map); 

        //create a fill pattern for red flag warning layer
        var fillPattern1 =  new L.StripePattern({
            angle: 30,
            weight: 5,
            color: 'black',
            opacity: 0.5,

        });

        fillPattern1.addTo(map);

        // red flag warning layer
            var nws_ww_rfw = L.esri.featureLayer({
            url: "https://idpgis.ncep.noaa.gov/arcgis/rest/services/NWS_Forecasts_Guidance_Warnings/watch_warn_adv/MapServer/1",
                where: "prod_type = 'Red Flag Warning'",
                //where: "prod_type = 'Fire Weather Watch'",
                style: {color:'#990000', weight:1, fillPattern: fillPattern1, fillOpacity: 0.3},
                attribution: "NOAA, NWS"
        })
        .addTo(map);

        // add in legend open / close functionality
        var legendButton = L.easyButton({
            states: [{
                stateName: 'layer-group-open',
                icon: 'fa-layer-group',
                title: 'View map legend',
                onClick: function(control) {
                    document.getElementById("legend").style.visibility = "visible";
                    var btn1 = $('button.easy-button-button.leaflet-bar-part.leaflet-interactive.layer-group-open-active')
                    var p1= $('div.leaflet-top.leaflet-left');
                    
                    var t = p1.height() - btn1.height();
                    var f = p1.width();
                    //console.log(t);
                    //console.log(f);
                   
                    $("#legend").parent().css({position: 'relative'});
                    $("#legend").css({top: 223, left: 44, position: 'absolute'});
                    //$("#legend").prop('width', '206px');
                    //$("#legend").prop('height', '189px');
                    
                    control.state('layer-group-close');
                }
            }, {
                icon: 'fa-undo',
                stateName: 'layer-group-close',
                title: 'Close map legend',
                onClick: function(control) {
                    document.getElementById("legend").style.visibility = "hidden";
                    control.state('layer-group-open');
                }
            }]
        });
        legendButton.addTo(map);

        // geolocate
        var locButton = L.easyButton({
            states:[
                {
                    icon: 'fa-location-crosshairs', 
                    title: 'Where am I?',
                    onClick: function(){map.locate({setView: true, maxZoom: 10});}
                }
            ]
        }).addTo(map);
        

        var locMarker;
        // once geolocated, add new or move existing marker
        map.on('locationfound', function(e){
            
            if (!locMarker) {
                locMarker = L.marker(e.latlng);
            } else {
                locMarker.setLatLng(e.latlng);
            }
            locMarker.addTo(map);
        })

        
        // reset map to initial extent and remove markers, etc.
        var initButton = L.easyButton({
            states: [
                {
                    icon: 'fa-house', 
                    title: 'Reset map',
                    onClick: function(){
                        map.setView([37.1661153,-119.451638], 7);
                        locMarker.remove();
                    }
                }
            ]
        }).addTo(map);

        //geocoder
        var searchControl = new L.esri.Geocoding.geosearch({
            providers: [
                L.esri.Geocoding.arcgisOnlineProvider({
                    // API Key to be passed to the ArcGIS Online Geocoding Service
                    apikey: apiKey
                })
            ]
        }).addTo(map);

        //geocoder results
        searchControl.on('results', function(data){
            
            if (!locMarker) {
                locMarker = L.marker(data.results[0].latlng);
            } else {
                locMarker.setLatLng(data.results[0].latlng);
            }
            
            map.setZoomAround(data.results[0].latlng, 10);
            locMarker.addTo(map);
        });

       map.on('moveend', function(e){
        var ne = map.getBounds().getNorthEast();
        var sw = map.getBounds().getSouthWest();
        console.log(ne.lat + ", " + ne.lng + ", " + sw.lat  + ", " + sw.lng  + ", " + map.getZoom());
        var ctr = map.getBounds().getCenter();
        console.log(ctr.lat + ", " + ctr.lng)
      }) 

        // add plugin
        L.simpleMapScreenshoter({
            // custom screenshot name
            screenName: function () {
                return "Northern California"
            }
        }).addTo(map);

        // show screening progress
        map.on('simpleMapScreenshoter.takeScreen', function () {
            document.getElementById('mapBigScreeningState').innerHTML = 'screening...<br>'
        })
        map.on('simpleMapScreenshoter.done', function () {
            document.getElementById('mapBigScreeningState').innerHTML = 'screen end...<br>'
        })
        map.on('simpleMapScreenshoter.error', function (event) {
            console.error(event.e)
            document.getElementById('mapBigScreeningState').innerHTML = event.e.toString() + '<br>'
        })
        

    </script>
</body>
</html>